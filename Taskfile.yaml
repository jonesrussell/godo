version: '3'

vars:
  GO_VERSION: 1.23
  CURRENT_OS:
    sh: go env GOOS

tasks:
  clean:wire:
    desc: Clean up wire-generated files
    cmds:
      - |
        cd internal/container && \
        {{if eq OS "windows"}}
        cmd /c "del /f *_wire_gen.go 2>nul || exit 0"
        {{else}}
        rm -f *_wire_gen.go || true
        {{end}}

  wire:all:
    desc: Generate wire code for all platforms
    deps: [clean:wire]
    cmds:
      - cd internal/container && wire gen -tags windows
      - cd internal/container && wire gen -tags darwin
      - cd internal/container && wire gen -tags linux

  wire:windows:
    desc: Generate wire code for Windows
    deps: [clean:wire]
    cmds:
      - cd internal/container && wire gen -tags windows

  build:windows:
    desc: Build for Windows
    deps: [wire:windows]
    cmds:
      - go build -tags windows -o bin/godo.exe cmd/godo/main.go

  build:all:
    desc: Build for all platforms
    deps: [wire:all, build:windows]
    cmds:
      - GOOS=darwin go build -tags darwin -o bin/godo-darwin cmd/godo/main.go
      - GOOS=linux go build -tags linux -o bin/godo-linux cmd/godo/main.go

  run:
    deps: [wire:all]
    cmds:
      - go run cmd/godo/main.go
